<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with Expert | SolutionHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root{
      --bg:#020617;
      --surface:#050816;
      --card:#020617;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#6366f1;
      --accent-soft:#4f46e5;
      --success:#22c55e;
      --danger:#ef4444;
      --radius:16px;
      --shadow:0 18px 40px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 40%,#000 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    body{display:flex;flex-direction:column;min-height:100vh}

    a{color:inherit;text-decoration:none}

    /* LAYOUT */
    .shell{
      max-width:1080px;
      margin:0 auto;
      padding:0 16px;
      width:100%;
    }

    /* HEADER */
    header{
      position:sticky;top:0;z-index:30;
      background:rgba(2,6,23,.96);
      backdrop-filter:blur(16px);
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      height:60px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand-row{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .brand-logo{
      width:30px;height:30px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#a855f7);
      display:grid;place-items:center;
      color:white;
      font-weight:800;
      font-size:16px;
    }
    .brand-text{
      font-size:16px;
      font-weight:700;
    }
    .brand-text span{color:var(--accent)}

    .header-meta{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 8px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill.online-dot{
      color:var(--success);
    }
    .dot{
      width:7px;height:7px;border-radius:999px;
      background:var(--success);
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .user-tag{
      display:flex;
      align-items:center;
      gap:8px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      font-size:12px;
    }
    .user-avatar-small{
      width:26px;height:26px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),#a855f7);
      display:grid;place-items:center;
      font-weight:700;
      font-size:13px;
      color:#fff;
    }
    .back-btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:12px;
      background:#020617;
      color:var(--text);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .back-btn:hover{
      border-color:var(--accent);
      color:var(--accent);
    }

    /* MAIN LAYOUT */
    main{
      flex:1;
      padding:18px 0 24px;
    }
    .chat-layout{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      gap:16px;
      align-items:flex-start;
    }
    @media(max-width:900px){
      .chat-layout{
        grid-template-columns:1fr;
      }
    }

    /* EXPERT CARD */
    .expert-card{
      background:var(--surface);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:18px 16px;
      position:sticky;
      top:76px;
    }
    @media(max-width:900px){
      .expert-card{
        position:static;
        box-shadow:none;
      }
    }
    .expert-avatar-wrap{
      display:flex;
      justify-content:center;
      margin-bottom:10px;
    }
    .expert-avatar{
      width:88px;height:88px;
      border-radius:999px;
      object-fit:cover;
      border:2px solid rgba(99,102,241,.4);
      display:block;
    }
    .avatar-fallback{
      width:88px;height:88px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),#a855f7);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:34px;
      font-weight:800;
    }
    .expert-name{
      text-align:center;
      font-size:18px;
      font-weight:700;
      margin-bottom:4px;
    }
    .expert-field{
      text-align:center;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--accent);
      margin-bottom:10px;
    }
    .expert-info{
      border-top:1px solid var(--border);
      margin-top:10px;
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:7px;
      font-size:12px;
      color:var(--muted);
    }
    .info-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .info-row i{width:14px;color:var(--accent);font-size:13px}
    .launch-box{
      margin-top:10px;
      border-radius:12px;
      border:1px solid rgba(34,197,94,.4);
      background:rgba(22,163,74,.12);
      padding:9px 10px;
      font-size:12px;
    }
    .launch-box strong{color:var(--success);display:block;margin-bottom:2px;font-size:13px}

    /* CHAT */
    .chat-section{
      background:var(--surface);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px 12px;
      display:flex;
      flex-direction:column;
      min-height:480px;
      max-height:calc(100vh - 120px);
    }
    @media(max-width:900px){
      .chat-section{
        max-height:none;
        min-height:420px;
      }
    }
    .chat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding-bottom:10px;
      border-bottom:1px solid var(--border);
      margin-bottom:8px;
    }
    .chat-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:15px;
      font-weight:600;
    }
    .chat-sub{
      font-size:11px;
      color:var(--muted);
    }
    .chat-status{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--success);
      font-weight:500;
    }
    .status-dot{
      width:7px;height:7px;border-radius:999px;
      background:var(--success);
      animation:pulse 1.6s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1);}
      50%{opacity:.5;transform:scale(.8);}
    }

    .chat-box{
      flex:1;
      display:flex;
      flex-direction:column;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:#020617;
      overflow:hidden;
    }
    .chat-messages{
      flex:1;
      padding:14px 12px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:13px;
    }
    .chat-messages::-webkit-scrollbar{width:6px}
    .chat-messages::-webkit-scrollbar-thumb{
      background:#111827;border-radius:999px;
    }

    .message{
      max-width:78%;
      padding:9px 11px;
      border-radius:13px;
      line-height:1.5;
      word-wrap:break-word;
      animation:msgIn .18s ease-out;
      box-shadow:0 8px 24px rgba(0,0,0,.55);
    }
    @keyframes msgIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    .message.me{
      align-self:flex-end;
      background:var(--accent-soft);
      color:#f9fafb;
      border-bottom-right-radius:4px;
    }
    .message.other{
      align-self:flex-start;
      background:#020617;
      border:1px solid #111827;
      border-bottom-left-radius:4px;
    }
    .message-sender{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:3px;
      opacity:.7;
    }
    .message-time{
      font-size:10px;
      opacity:.6;
      margin-top:3px;
      text-align:right;
    }

    .empty-state,.loading-messages{
      text-align:center;
      color:var(--muted);
      padding:36px 12px;
      font-size:13px;
    }
    .empty-state i,
    .loading-messages i{
      font-size:32px;
      opacity:.35;
      margin-bottom:10px;
      display:block;
    }

    .typing-indicator{
      align-self:flex-start;
      background:#020617;
      border-radius:12px;
      border:1px solid #111827;
      padding:7px 9px;
      display:inline-flex;
      gap:5px;
    }
    .typing-dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);
      animation:typing 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    @keyframes typing{
      0%,60%,100%{transform:translateY(0)}
      30%{transform:translateY(-4px)}
    }

    .chat-input-area{
      display:flex;
      gap:8px;
      padding:10px 10px;
      border-top:1px solid var(--border);
      background:#020617;
    }
    .chat-input-area input{
      flex:1;
      border-radius:12px;
      border:1px solid #111827;
      background:#020617;
      color:var(--text);
      padding:9px 11px;
      font-size:13px;
      outline:none;
    }
    .chat-input-area input::placeholder{color:var(--muted)}
    .chat-input-area input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(99,102,241,.35);
    }
    .send-btn{
      border:none;
      border-radius:12px;
      background:var(--accent);
      color:#f9fafb;
      padding:0 14px;
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      min-width:80px;
      justify-content:center;
    }
    .send-btn:disabled{
      opacity:.6;
      cursor:default;
    }

    @media(max-width:640px){
      .chat-section{
        padding:10px 8px;
      }
      .chat-input-area{
        padding:8px;
      }
      .chat-input-area input{
        font-size:14px;
      }
      .send-btn{
        padding:0 12px;
        min-width:72px;
      }
      .header-inner{
        padding-inline:8px;
      }
    }

    /* FOOTER */
    footer{
      border-top:1px solid var(--border);
      padding:10px 16px 14px;
      font-size:11px;
      color:var(--muted);
      background:#020617;
    }
    .footer-row{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      bottom:14px;
      left:50%;
      transform:translateX(-50%) translateY(30px);
      background:#16a34a;
      color:#f9fafb;
      padding:7px 11px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      transition:all .2s ease-out;
      z-index:40;
      max-width:90%;
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
    .toast.error{background:var(--danger)}
  </style>
</head>
<body>

<header>
  <div class="shell header-inner">
    <div class="brand-row" onclick="location.href='/experts.html'">
      <div class="brand-logo">S</div>
      <div>
        <div class="brand-text">Solution<span>Hub</span></div>
        <div class="chat-sub">Live 1‑to‑1 with verified experts</div>
      </div>
    </div>

    <div class="header-meta">
      <div class="pill online-dot">
        <span class="dot"></span>
        <span>Secure private room</span>
      </div>
    </div>

    <div class="header-actions">
      <div class="user-tag">
        <div class="user-avatar-small" id="userAvatarSmall">U</div>
        <span id="loggedInUser">User</span>
      </div>
      <button class="back-btn" onclick="location.href='/experts.html'">
        <i class="fa-solid fa-arrow-left"></i>
        Back
      </button>
    </div>
  </div>
</header>

<main>
  <div class="shell">
    <div class="chat-layout">
      <!-- Expert sidebar -->
      <aside class="expert-card">
        <div class="expert-avatar-wrap" id="expertAvatar"></div>
        <div class="expert-name" id="expertName">Loading…</div>
        <div class="expert-field" id="expertField">Expert</div>

        <div class="expert-info">
          <div class="info-row">
            <i class="fa-solid fa-briefcase"></i>
            <span><span id="expertExp">0</span>+ years experience</span>
          </div>
          <div class="info-row">
            <i class="fa-solid fa-envelope"></i>
            <span id="expertEmail" style="font-size:11px;">---</span>
          </div>
          <div class="info-row">
            <i class="fa-solid fa-circle-check" style="color:var(--success);"></i>
            <span>Verified SolutionHub expert</span>
          </div>
        </div>

        <div class="launch-box">
          <strong>Launch offer</strong>
          <span>Free or discounted sessions while the network is in early access.</span>
        </div>
      </aside>

      <!-- Chat section -->
      <section class="chat-section">
        <div class="chat-header">
          <div>
            <div class="chat-title">
              <i class="fa-solid fa-comments"></i>
              <span>Live chat</span>
            </div>
            <div class="chat-sub">Ask, clarify, share screenshots (by link), and get direct guidance.</div>
          </div>
          <div class="chat-status">
            <div class="status-dot"></div>
            <span>Connected</span>
          </div>
        </div>

        <div class="chat-box">
          <div class="chat-messages" id="chatMessages">
            <div class="loading-messages">
              <i class="fa-solid fa-spinner fa-spin"></i>
              Loading previous messages…
            </div>
          </div>

          <div class="chat-input-area">
            <input
              type="text"
              id="chatInput"
              placeholder="Type your message and press Enter…"
              onkeypress="if(event.key==='Enter') sendMessage()"
              oninput="handleTyping()"
            >
            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
              <i class="fa-solid fa-paper-plane"></i>
              Send
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  <div class="footer-row">
    <span>© 2026 SolutionHub. Human experts + smart tools, for real‑world problems.</span>
    <span><i class="fa-solid fa-shield-halved" style="margin-right:4px;color:var(--success);"></i>Private, encrypted room between you and your expert.</span>
  </div>
</footer>

<script>
  // ===== AUTH & SETUP =====
  const urlParams = new URLSearchParams(window.location.search);
  const expertEmail = urlParams.get('email');
  const clientEmail = localStorage.getItem('email');
  const clientName = localStorage.getItem('name') || localStorage.getItem('username') || (clientEmail ? clientEmail.split('@')[0] : 'User');
  const token = localStorage.getItem('token');

  let expertData = null;
  let socket = null;
  let roomId = null;
  let typingTimeout = null;
  let isTyping = false;
  const displayedMessageIds = new Set();

  if (!token || !clientEmail) {
    alert('Please login to chat with an expert');
    location.href = '/login.html';
  }

  document.getElementById('loggedInUser').textContent = clientName;
  document.getElementById('userAvatarSmall').textContent = clientName[0]?.toUpperCase() || 'U';

  // ===== EXPERT DATA =====
  async function loadExpert() {
    try {
      const res = await fetch('/api/profile?email=' + encodeURIComponent(expertEmail));
      expertData = await res.json();

      document.getElementById('expertName').textContent = expertData.name || 'Expert';
      document.getElementById('expertField').textContent = expertData.field || 'General expert';
      document.getElementById('expertExp').textContent = expertData.experience || 0;
      document.getElementById('expertEmail').textContent = expertData.email || '---';

      const avatarContainer = document.getElementById('expertAvatar');
      if (expertData.avatar) {
        const imgSrc = expertData.avatar.includes('uploads')
          ? '/' + expertData.avatar
          : '/uploads/photos/' + expertData.avatar;

        avatarContainer.innerHTML = `
          <img src="${imgSrc}" alt="${expertData.name || 'Expert'}"
               class="expert-avatar"
               onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
          <div class="avatar-fallback" style="display:none;">
            ${(expertData.name || 'E')[0].toUpperCase()}
          </div>
        `;
      } else {
        avatarContainer.innerHTML = `
          <div class="avatar-fallback">
            ${(expertData.name || 'E')[0].toUpperCase()}
          </div>
        `;
      }
    } catch (err) {
      console.error('Error loading expert', err);
      alert('Failed to load expert details');
      location.href = '/experts.html';
    }
  }

  // ===== CHAT HISTORY =====
  async function loadChatHistory() {
    try {
      const res = await fetch('/api/messages?room=' + encodeURIComponent(roomId));
      const messages = await res.json();
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';
      displayedMessageIds.clear();

      if (!messages.length) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-comments"></i>
            <h4 style="margin-bottom:4px;">Start the conversation</h4>
            <p>Send your first message to this expert.</p>
          </div>
        `;
        return;
      }

      messages.forEach(msg => displayMessage(msg,false));
    } catch (err) {
      console.error('Error loading history', err);
      document.getElementById('chatMessages').innerHTML = `
        <div class="empty-state">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <h4 style="margin-bottom:4px;">Could not load messages</h4>
          <p>You can still start a new chat below.</p>
        </div>
      `;
    }
  }

  // ===== SOCKET + CHAT =====
  function initializeChat() {
    roomId = [clientEmail, expertEmail].sort().join('_');

    loadChatHistory();

    socket = io();

    socket.on('connect', () => {
      socket.emit('join_private', roomId);
      socket.emit('user_online', { email: clientEmail, name: clientName, role: 'client' });
    });

    socket.on('receive_message', data => {
      if (data.author === clientEmail) return; // ignore echo
      displayMessage(data,true);
    });

    socket.on('user_typing', data => {
      if (data.room === roomId && data.author !== clientEmail) {
        showTypingIndicator();
      }
    });

    socket.on('user_stopped_typing', data => {
      if (data.room === roomId) hideTypingIndicator();
    });

    socket.on('connect_error', err => console.error('Socket error', err));
    socket.on('disconnect', () => console.log('Socket disconnected'));
  }

  function sendMessage() {
    const input = document.getElementById('chatInput');
    const btn = document.getElementById('sendBtn');
    const message = input.value.trim();
    if (!message || !socket) return;

    btn.disabled = true;

    const payload = {
      room: roomId,
      author: clientEmail,
      authorRole: 'client',
      message
    };

    // show immediately
    displayMessage({
      author: clientEmail,
      message,
      createdAt: new Date().toISOString()
    },true);

    socket.emit('send_private_message', payload);
    socket.emit('stop_typing',{ room: roomId });

    input.value = '';

    setTimeout(() => {
      btn.disabled = false;
      input.focus();
    },300);
  }

  function displayMessage(data,isNew){
    const container = document.getElementById('chatMessages');
    const empty = container.querySelector('.empty-state,.loading-messages');
    if (empty) empty.remove();

    const id = (data._id || '') + '|' + (data.createdAt || '') + '|' + data.message;
    if (id && displayedMessageIds.has(id)) return;
    if (id) displayedMessageIds.add(id);

    const div = document.createElement('div');
    const isMe = data.author === clientEmail;
    div.className = 'message ' + (isMe ? 'me':'other');

    const senderName = isMe ? 'You' : (expertData?.name || 'Expert');
    const ts = data.createdAt
      ? new Date(data.createdAt).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})
      : new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

    div.innerHTML = `
      <div class="message-sender">${senderName}</div>
      ${escapeHtml(data.message || '')}
      <div class="message-time">${ts}</div>
    `;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function handleTyping(){
    if (!socket || !roomId) return;
    if (!isTyping){
      isTyping = true;
      socket.emit('typing',{ room: roomId, name: clientName, author: clientEmail });
    }
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{
      isTyping = false;
      socket.emit('stop_typing',{ room: roomId });
    },900);
  }

  function showTypingIndicator(){
    const container = document.getElementById('chatMessages');
    let indicator = document.getElementById('typingIndicator');
    if (!indicator){
      indicator = document.createElement('div');
      indicator.id = 'typingIndicator';
      indicator.className = 'typing-indicator';
      indicator.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      container.appendChild(indicator);
      container.scrollTop = container.scrollHeight;
    }
  }
  function hideTypingIndicator(){
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
  }

  function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showToast(msg,isError){
    const t=document.createElement('div');
    t.className='toast'+(isError?' error':'');
    t.textContent=msg;
    document.body.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    setTimeout(()=>t.classList.remove('show'),2600);
    setTimeout(()=>t.remove(),3000);
  }

  window.sendMessage = sendMessage;
  window.handleTyping = handleTyping;

  window.addEventListener('load', () => {
    if (!expertEmail){
      alert('No expert selected');
      location.href='/experts.html';
      return;
    }
    loadExpert();
    initializeChat();
  });

  window.addEventListener('beforeunload', () => {
    if (socket) socket.disconnect();
  });

  console.log('Client chat ready');
</script>

</body>
</html>
